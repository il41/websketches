<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<script src="https://cdn.jsdelivr.net/npm/p5@1.11.0/lib/p5.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/p5@1.11.0/lib/addons/p5.sound.min.js"></script>
<style>
html, body {margin:0; padding:0; overflow:hidden; font-family:monospace; color:white; font-weight:100;}
canvas { display:block; position:fixed; top:0; left:0; z-index:0;}
.ui { position:absolute; top:20px; left:20px; z-index:10; background:rgba(0,0,0,0.5); padding:10px; border-radius:6px;}
h1{margin:0 0 10px 0; font-size:28px;}
p{margin:0 0 10px 0;}
.slider-label{margin-top:5px; display:block; font-size:14px;}
button{padding:8px 14px; font-size:14px; margin-top:10px; cursor:pointer;}
select{margin-top:5px;}
</style>
</head>
<body>
<div class="ui">
<h1>digital synth 3</h1>
<p style="font-family:monospace;">\www.ilai.link 2025 A.D./<br>
<button id="startButton">Start Audio</button><br/>
<label class="slider-label">Volume</label>
<input type="range" id="volSlider" min="0" max="1" step="0.01" value="0.5">
<label class="slider-label">Attack</label>
<input type="range" id="attackSlider" min="0.001" max="1" step="0.001" value="0.05">
<label class="slider-label">Decay</label>
<input type="range" id="decaySlider" min="0.001" max="1" step="0.001" value="0.2">
<label class="slider-label">Sustain</label>
<input type="range" id="sustainSlider" min="0" max="1" step="0.01" value="0.5">
<label class="slider-label">Release</label>
<input type="range" id="releaseSlider" min="0.001" max="2" step="0.001" value="0.5">
<label class="slider-label">Random Octave Up</label>
<select id="randUp">
  <option value="0">0</option>
  <option value="1">1</option>
  <option value="2">2</option>
  <option value="3">3</option>
  <option value="4">4</option>
  <option value="5">5</option>
</select>
<label class="slider-label">Random Octave Down</label>
<select id="randDown">
  <option value="0">0</option>
  <option value="1">1</option>
  <option value="2">2</option>
  <option value="3">3</option>
  <option value="4">4</option>
  <option value="5">5</option>
</select>
<p id="octaveDisplay">Octave: 4</p>
</div>

<script>
let masterGain, synth;
let activeNotes = {};
let balls = [];
let octave = 4;

const whiteKeys = ['a','s','d','f','g','h','j','k','l',';'];
const blackKeys = ['w','e','t','y','u','o','p'];

// MIDI semitone offsets for keys
const whiteSemitones = [0,2,4,5,7,9,11,12,14,16]; // relative to C of base octave
const blackSemitones = [1,3,6,8,10,13,15]; // relative to C of base octave

function midiToFreq(midi){ return 440 * Math.pow(2,(midi-69)/12); }
function getADSR(){ return {
  a: parseFloat(document.getElementById("attackSlider").value),
  d: parseFloat(document.getElementById("decaySlider").value),
  s: parseFloat(document.getElementById("sustainSlider").value),
  r: parseFloat(document.getElementById("releaseSlider").value)
}; }

function playNoteForKey(k, midi){
  if(activeNotes[k]) return;

  const freq = midiToFreq(midi);
  const osc = new p5.Oscillator('sine');
  osc.freq(freq); osc.start();

  const voiceGain = getAudioContext().createGain();
  voiceGain.gain.value = 0.0001;
  osc.disconnect(); osc.connect(voiceGain); voiceGain.connect(masterGain);

  const {a,d,s} = getADSR();
  const now = getAudioContext().currentTime;
  voiceGain.gain.cancelScheduledValues(now);
  voiceGain.gain.setValueAtTime(0.0001, now);
  voiceGain.gain.linearRampToValueAtTime(1.0, now + a);
  voiceGain.gain.linearRampToValueAtTime(s, now + a + d);

  const circleColor = [random(100,255), random(100,255), random(255)];
  const ball = { x: random(50,width-50), y: random(50,height-200), r:0, maxR:50+random(50),
                 alpha:255, color:circleColor, gainNode:voiceGain, state:'active', releaseStart:0 };
  balls.push(ball);

  activeNotes[k] = {osc, gainNode:voiceGain, ball, color:circleColor};
}

function stopNoteByKey(k){
  const record = activeNotes[k];
  if(!record) return;
  const {osc, gainNode, ball} = record;
  const {r} = getADSR();
  const now = getAudioContext().currentTime;

  // Use the correct gain node
  gainNode.gain.cancelScheduledValues(now);
  gainNode.gain.setValueAtTime(gainNode.gain.value, now);
  gainNode.gain.linearRampToValueAtTime(0.0001, now + r);

  ball.state = 'release';
  ball.releaseStart = millis();
  ball.releaseRadius = ball.r;

  setTimeout(()=>{ osc.stop(); osc.disconnect(); gainNode.disconnect(); }, Math.max(1, r*1000 + 50));
  delete activeNotes[k];
}


function keyToMIDI(k){
  k = k.toLowerCase();
  if(k==='z'||k==='x') return null;
  const randUp=parseInt(document.getElementById("randUp").value);
  const randDown=parseInt(document.getElementById("randDown").value);

  const widx=whiteKeys.indexOf(k);
  if(widx!==-1){
    const shift=floor(random(-randDown,randUp+1))*12;
    return 12*(octave+1)+whiteSemitones[widx]+shift;
  }
  const bidx=blackKeys.indexOf(k);
  if(bidx!==-1){
    const shift=floor(random(-randDown,randUp+1))*12;
    return 12*(octave+1)+blackSemitones[bidx]+shift;
  }
  return null;
}

function setup(){
  createCanvas(windowWidth,windowHeight);
  masterGain = getAudioContext().createGain();
  masterGain.gain.value=parseFloat(document.getElementById("volSlider").value);
  masterGain.connect(getAudioContext().destination);
  document.getElementById("volSlider").oninput = ()=>{ 
    masterGain.gain.setValueAtTime(parseFloat(volSlider.value), getAudioContext().currentTime);
  }
  document.getElementById("startButton").addEventListener("click", ()=>{
    getAudioContext().resume().then(()=>{ synth = new p5.PolySynth(); });
  });
  textAlign(CENTER,CENTER); textSize(14);
}

function draw(){
  background(20,25,35);
  for(let i=balls.length-1;i>=0;i--){
    const b=balls[i];
    const gainVal=b.gainNode ? b.gainNode.gain.value : 1;
    if(b.state==='release'){
      const r=parseFloat(document.getElementById("releaseSlider").value)*1000;
      const t=constrain((millis()-b.releaseStart)/r,0,1);
      b.alpha=lerp(255,0,t);
      b.r=lerp(b.releaseRadius,b.releaseRadius*1.1,t);
      if(t>=1){ balls.splice(i,1); continue; }
    } else { b.r=b.maxR*gainVal; b.alpha=255; }
    fill(b.color[0],b.color[1],b.color[2],b.alpha);
    ellipse(b.x,b.y,b.r*2);
  }

  // keyboard drawing
  const maxKeyboardWidth=900;
  const kbWidth=min(width-40,maxKeyboardWidth);
  const wKeyW=kbWidth/whiteKeys.length;
  const startX=(width-kbWidth)/2;
  const startY=height-180;
  const wKeyH=160;

  for(let i=0;i<whiteKeys.length;i++){
    const x=startX+i*wKeyW;
    const k=whiteKeys[i];
    const pressed=!!activeNotes[k];
    fill(pressed?activeNotes[k].color:255);
    stroke(200); rect(x,startY,wKeyW-2,wKeyH,6);
    fill(0); noStroke(); text(k.toUpperCase(),x+wKeyW/2,startY+wKeyH-24);
  }

  const blackOffsets=[0*wKeyW+wKeyW*0.65,1*wKeyW+wKeyW*0.65,3*wKeyW+wKeyW*0.65,4*wKeyW+wKeyW*0.65,5*wKeyW+wKeyW*0.65,7*wKeyW+wKeyW*0.65,8*wKeyW+wKeyW*0.65];
  const bW=40,bH=100;
  for(let i=0;i<blackKeys.length;i++){
    const x=startX+blackOffsets[i];
    const k=blackKeys[i];
    const pressed=!!activeNotes[k];
    fill(pressed?activeNotes[k].color:0);
    stroke(60); rect(x,startY,bW,bH,6);
    fill(255); noStroke(); text(k.toUpperCase(),x+bW/2,startY+bH-18);
  }
}

function keyPressed(){
  if(key==='z'){ octave=max(0,octave-1); document.getElementById("octaveDisplay").innerText="Octave: "+octave; return; }
  if(key==='x'){ octave=min(8,octave+1); document.getElementById("octaveDisplay").innerText="Octave: "+octave; return; }

  if(activeNotes[key]) return;
  const midi=keyToMIDI(key);
  if(midi!==null) playNoteForKey(key,midi);
}

function keyReleased(){
  if(!activeNotes[key]) return;
  stopNoteByKey(key);
}

window.addEventListener('blur',()=>{ for(const k in {...activeNotes}) stopNoteByKey(k); });
function windowResized(){ resizeCanvas(windowWidth,windowHeight); }
</script>
</body>
</html>
